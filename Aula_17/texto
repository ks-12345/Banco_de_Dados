CREATE DATABASE Oficina;

USE Oficina;

CREATE TABLE Mecanicos (
Nome_Mec Varchar (255) not null,
Id_Mec int auto_increment PRIMARY KEY,
Salario decimal (6,2) not null
);

CREATE TABLE Veiculos (
Ano varchar (4) not null,
Id_Veic int auto_increment  PRIMARY KEY,
Marca varchar(255) not null,
Cor varchar(50) not null,
Modelo varchar (200) not null,
Placa varchar(7) not null
);

CREATE TABLE Clientes (
Telefone varchar(15) not null,
Nome_Cliente varchar(255) not null,
Id_Cliente int auto_increment PRIMARY KEY,
Endereco varchar(255) not null,
Id_Veic int NOT NULL,
FOREIGN KEY(Id_Veic) REFERENCES Veiculos (Id_Veic)
);

   CREATE TABLE Servicos (
Descricao varchar(255) not null,
Id_Servico int auto_increment PRIMARY KEY,
Tipo_Servico Varchar(255),
Preco decimal(8,2),
Id_Produto int not null,
FOREIGN KEY(Id_Produto) REFERENCES Produtos (Id_Produto)
);

CREATE TABLE Produtos (
Id_Produto int auto_increment  PRIMARY KEY,
Especificacoes varchar(255) not null,
Nome varchar(255) not null,
Preco_Produto decimal(6,2) not null
);

CREATE TABLE OS (
Numero_Ordem int auto_increment  PRIMARY KEY,
Total decimal (8,2),
Responsaveis varchar(255),
Descriçao_Ordem varchar(255),
Qtde_Produto int,
Id_Produto int,
FOREIGN KEY(Id_Produto) REFERENCES Produtos (Id_Produto)
);

CREATE TABLE Estoque (
Id_Esto int auto_increment  PRIMARY KEY,
Data_Incio date,
Qtde_Produto varchar(255),
 Valor_Produto decimal (8,2),
Data_Final date,
Nome_Produtos varchar(255)
);

CREATE TABLE realiza (
Id_Servico int ,
Id_Mec int,
FOREIGN KEY(Id_Servico) REFERENCES Servicos (Id_Servico),
FOREIGN KEY(Id_Mec) REFERENCES Mecanicos (Id_Mec)
);

CREATE TABLE Tem (
Id_Esto int ,
Id_Produto int ,
FOREIGN KEY(Id_Esto) REFERENCES Estoque (Id_Esto),
FOREIGN KEY(Id_Produto) REFERENCES Produtos (Id_Produto)
);

CREATE TABLE Referente (
Id_Veic int,
Numero_Ordem int,
FOREIGN KEY(Id_Veic) REFERENCES Veiculos (Id_Veic),
FOREIGN KEY(Numero_Ordem) REFERENCES OS (Numero_Ordem)
);

CREATE TABLE Executa (
Id_Mec int,
Numero_Ordem int,
FOREIGN KEY(Id_Mec) REFERENCES Mecanicos (Id_Mec),
FOREIGN KEY(Numero_Ordem) REFERENCES OS (Numero_Ordem)
);

ALTER TABLE Servicos ADD FOREIGN KEY(Id_Produto) REFERENCES Produtos (Id_Produto);

INSERT INTO Mecanicos (Nome_Mec, Salario) VALUES
('Carlos Almeida', 3200.00),
('João Pereira', 4500.00),
('Marcos Santos', 3800.00);

INSERT INTO Veiculos (Ano, Marca, Cor, Modelo, Placa) VALUES
('2018', 'Toyota', 'Prata', 'Corolla', 'ABC1234'),
('2015', 'Honda', 'Preto', 'Civic', 'XYZ5678'),
('2020', 'Ford', 'Branco', 'Ka', 'JKL9087');

INSERT INTO Produtos (Especificacoes, Nome, Preco_Produto) VALUES
('Óleo sintético 5W30', 'Óleo Motor', 45.50),
('Filtro de ar esportivo', 'Filtro de Ar', 30.00),
('Pastilha de freio dianteira', 'Pastilha de Freio', 120.00);

INSERT INTO Clientes (Telefone, Nome_Cliente, Endereco, Id_Veic) VALUES
('11999990000', 'Ana Silva', 'Rua A, 123', 1),
('11988880000', 'Pedro Costa', 'Av B, 456', 2),
('11977770000', 'Mariana Torres', 'Rua C, 789', 3);

INSERT INTO Servicos (Descricao, Tipo_Servico, Preco, Id_Produto) VALUES
('Troca de óleo completa', 'Manutenção', 150.00, 1),
('Troca do filtro de ar', 'Manutenção', 80.00, 2),
('Troca de pastilha de freio', 'Reparo', 250.00, 3);

INSERT INTO OS (Total, Responsaveis, Descriçao_Ordem, Qtde_Produto, Id_Produto) VALUES
(250.00, 'Carlos Almeida', 'Troca de óleo', 1, 1),
(180.00, 'João Pereira', 'Troca de filtro de ar', 1, 2),
(370.00, 'Marcos Santos', 'Troca de pastilhas', 1, 3);

INSERT INTO Estoque (Data_Incio, Qtde_Produto, Valor_Produto, Data_Final, Nome_Produtos) VALUES
('2025-01-01', '50', 45.50, '2025-06-01', 'Óleo Motor'),
('2025-01-15', '70', 30.00, '2025-06-15', 'Filtro de Ar'),
('2025-02-01', '40', 120.00, '2025-07-01', 'Pastilha de Freio');


SELECT * FROM Veiculos
WHERE Marca = "Ford";


SELECT * FROM OS
WHERE Data_Entrada > '2023-05-01';

SELECT * FROM Mecanicos
WHERE Especialidade = "Injeção Eletrônica";

SELECT * FROM OS
WHERE Status_OS = "Aguardando Peças";

SELECT * FROM Peca
WHERE qtd_estoque < 4;

UPDATE Mecanicos
WHERE id_mecanico = 3;

SELECT nome, preco_venda
FROM pecas
WHERE preco_custo > 200.00;

UPDATE Pecas
SET preco_venda = preco_venda * 1.05
WHERE fabricante = 'Bosch';

UPDATE Ordens_Servico
SET status = 'Concluída'
WHERE Numero_Ordem = 105;

UPDATE Ordens_Servico
SET data_conclusao = CURRENT_DATE
WHERE status = 'Em Execução'
  AND data_abertura < CURRENT_DATE - INTERVAL 30 DAY;

UPDATE Pecas
SET qtd_estoque = qtd_estoque * 2
WHERE id_peca = 20;

ALTER TABLE Clientes
ADD email VARCHAR(100);

ALTER TABLE Mecanicos
MODIFY COLUMN especialidade VARCHAR(150);

ALTER TABLE Ordens_Servico
DROP COLUMN diagnostico_entrada;

ALTER TABLE Pecas
ADD CONSTRAINT chk_precos CHECK (preco_venda >= preco_custo);

*
SELECT 
    V.placa,
    V.modelo
FROM Ordens_Servico OS
JOIN Veiculos V ON OS.id_veiculo = V.id_veiculo
WHERE OS.status = 'Em Execução';

*
SELECT DISTINCT
    C.nome
FROM Clientes C
JOIN Veiculos V ON C.id_cliente = V.id_cliente
WHERE V.marca = 'Volkswagen';

*
SELECT DISTINCT
    M.nome
FROM Mecanicos M
JOIN OS_Mecanicos OSM ON M.id_mecanico = OSM.id_mecanico;

*
SELECT DISTINCT
    S.nome_servico
FROM Servicos S
JOIN OS_Servicos OSS ON S.id_servico = OSS.id_servico;

*
SELECT 
    C.id_cliente,
    C.nome,
    OS.id_os
FROM Clientes C
LEFT JOIN Ordens_Servico OS 
       ON C.id_cliente = OS.id_cliente
ORDER BY C.id_cliente;

*
SELECT 
    M.id_mecanico,
    M.nome,
    COUNT(OSM.id_os) AS total_os
FROM Mecanicos M
LEFT JOIN OS_Mecanicos OSM 
       ON M.id_mecanico = OSM.id_mecanico
GROUP BY M.id_mecanico, M.nome
ORDER BY total_os DESC;

*
SELECT 
    P.id_peca,
    P.nome,
    COALESCE(SUM(OSP.quantidade_usada), 0) AS total_vendida
FROM Pecas P
LEFT JOIN OS_Pecas OSP 
       ON P.id_peca = OSP.id_peca
GROUP BY P.id_peca, P.nome
ORDER BY total_vendida DESC;

*
SELECT 
    V.id_veiculo,
    V.placa,
    V.modelo,
    MAX(OS.data_abertura) AS ultima_os
FROM Veiculos V
LEFT JOIN Ordens_Servico OS 
       ON V.id_veiculo = OS.id_veiculo
GROUP BY V.id_veiculo, V.placa, V.modelo
ORDER BY ultima_os DESC;

UPDATE Pecas
SET  preco_venda= preco_venda * 0.05
WHERE fabricante = 'Bosch';

UPDATE OS
SET STATUS = "Concluída"
WHERE Numero_Ordem = 105;

UPDATE OS
SET data_conclusao = CURRENT_DATE
WHERE status = "Em Execução"
AND data_abertura < CURRENT_DATE - INTERVAL 30 DAY;

UPDATE Pecas
SET qtd_estoque = qtd_estoque * 2
WHERE id_peca = 20;

SELECT 
    C.id_cliente,
    C.nome,
    OS.id_os
FROM Clientes C
LEFT JOIN Ordens_Servico OS 
       ON C.id_cliente = OS.id_cliente
ORDER BY C.id_cliente;

SELECT 
    M.id_mecanico,
    M.nome,
    COUNT(OSM.id_os) AS total_os

SELECT 
    C.id_cliente,
    C.nome,
    OS.id_os
FROM Clientes C
LEFT JOIN Ordens_Servico OS 
       ON C.id_cliente = OS.id_cliente
ORDER BY C.id_cliente;

SELECT 
    M.id_mecanico,
    M.nome,
    COUNT(OSM.id_os) AS total_os
FROM Mecanicos M
LEFT JOIN OS_Mecanicos OSM
       ON M.id_mecanico = OSM.id_mecanico
GROUP BY M.id_mecanico, M.nome
ORDER BY total_os DESC;

SELECT 
    P.id_peca,
    P.nome,
    COALESCE(SUM(OSP.quantidade_usada), 0) AS total_vendida
FROM Pecas P
LEFT JOIN OS_Pecas OSP
       ON P.id_peca = OSP.id_peca
GROUP BY P.id_peca, P.nome
ORDER BY total_vendida DESC;

SELECT 
    V.id_veiculo,
    V.placa,
    V.modelo,
    MAX(OS.data_abertura) AS ultima_os
FROM Veiculos V
LEFT JOIN Ordens_Servico OS
       ON V.id_veiculo = OS.id_veiculo
GROUP BY V.id_veiculo, V.placa, V.modelo
ORDER BY ultima_os DESC;

SELECT 
    OS.id_os,
    OS.data_abertura,
    C.nome AS cliente
FROM Clientes C
RIGHT JOIN Ordens_Servico OS
       ON C.id_cliente = OS.id_cliente;

SELECT 
    S.id_servico,
    S.nome_servico,
    OSS.id_os
FROM OS_Servicos OSS
RIGHT JOIN Servicos S
       ON OSS.id_servico = S.id_servico;

SELECT 
    OSM.id_os,
    OSM.id_mecanico,
    M.nome AS nome_mecanico
FROM Mecanicos M
RIGHT JOIN OS_Mecanicos OSM
       ON M.id_mecanico = OSM.id_mecanico;

SELECT 
    OS.id_os,
    V.id_veiculo,
    V.placa,
    V.modelo
FROM Ordens_Servico OS
RIGHT JOIN Veiculos V
       ON OS.id_veiculo = V.id_veiculo;

SELECT 
C.id_cliente,
C.nome,
COUNTS.OS.id_os AS total_os
FROM Clientes C
JOIN Ordens_Servico OS
ON C.id_cliente = OS.id_cliente
GROUP BY C.id_cliente, C.nome
HAVING total_os > 3;


